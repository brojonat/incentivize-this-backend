{{define "create-bounty-form"}}
<!-- Form -->
<form
  id="create-bounty-form"
  hx-post="/forms/create-bounty"
  hx-target="#create-bounty-form-container"
  hx-swap="innerHTML"
>
  <!-- Requirements -->
  <div class="filter-section">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
      <label class="filter-label" style="margin: 0">Requirements</label>
      <button
        type="button"
        id="harden-button"
        class="ai-harden-button"
      >
        <span id="harden-button-text">‚ú® Harden with AI</span>
      </button>
    </div>
    <textarea
      class="filter-input"
      id="requirements"
      name="requirements"
      placeholder="Describe what content you want created..."
      rows="4"
      required
      style="width: 100%; resize: vertical; font-family: inherit"
    ></textarea>
  </div>

  <!-- Reward and Count (Single Row) -->
  <div class="filter-section">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem">
      <div>
        <label class="filter-label">Reward (USD)</label>
        <input
          type="number"
          id="reward_per_post"
          name="reward_per_post"
          inputmode="decimal"
          class="filter-input"
          placeholder="0.00"
          step="0.01"
          min="0"
          required
          style="width: 100%"
        />
      </div>
      <div>
        <label class="filter-label">Quantity</label>
        <input
          type="number"
          id="number_of_bounties"
          name="number_of_bounties"
          inputmode="numeric"
          class="filter-input"
          placeholder="1"
          step="1"
          min="1"
          required
          style="width: 100%"
        />
      </div>
    </div>
  </div>

  <!-- Duration -->
  <div class="filter-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
      <label class="filter-label" style="margin: 0;">Bounty Expiration</label>
      <button
        type="button"
        id="toggle-calendar"
        style="
          background: rgba(160, 202, 252, 0.15);
          border: 1px solid rgba(160, 202, 252, 0.4);
          border-radius: 6px;
          padding: 0.4rem 0.8rem;
          font-size: 0.8rem;
          color: var(--text-primary);
          cursor: pointer;
          transition: all 0.2s;
        "
      >
        üìÖ Use Calendar
      </button>
    </div>

    <!-- Duration dropdown (shown by default) -->
    <div id="duration-input">
      <select
        id="duration"
        class="filter-input"
        style="width: 100%"
      >
        <option value="1">1 day</option>
        <option value="7">7 days</option>
        <option value="14">14 days</option>
        <option value="30" selected>30 days</option>
        <option value="60">60 days</option>
        <option value="90">90 days</option>
        <option value="180">180 days</option>
      </select>
    </div>

    <!-- Calendar picker (hidden by default) -->
    <div id="calendar-input" style="display: none">
      <input
        type="datetime-local"
        id="bounty-end-date"
        class="filter-input"
        style="width: 100%"
      >
      <p id="duration-error" style="color: rgb(244, 67, 54); font-size: 0.8rem; margin-top: 0.5rem; display: none;"></p>
      <p id="calculated-duration" style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 0.5rem;"></p>
    </div>

    <!-- Hidden input for timestamp -->
    <input type="hidden" id="timeout_timestamp" name="timeout_timestamp">
  </div>

  <!-- Cost Breakdown -->
  <div style="
      background-color: rgba(160, 202, 252, 0.1);
      border: 1px solid rgba(160, 202, 252, 0.3);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    ">
    <p style="font-size: 0.875rem; color: var(--text-primary); margin: 0 0 0.75rem 0; font-weight: 600;">
      Cost Breakdown
    </p>
    <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
      <span>Subtotal:</span>
      <span id="cost-subtotal">$0.00</span>
    </div>
    <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
      <span>Platform Fee:</span>
      <span id="cost-fee">$0.00</span>
    </div>
    <div style="display: flex; justify-content: space-between; font-size: 1rem; color: var(--text-primary); font-weight: 600; padding-top: 0.5rem; border-top: 1px solid rgba(160, 202, 252, 0.3);">
      <span>Total:</span>
      <span id="cost-total">$0.00</span>
    </div>
  </div>

  <!-- Form Response Area -->
  <div id="form-response" style="margin-bottom: 1rem"></div>

  <!-- Actions -->
  <div class="filter-actions">
    <button
      type="button"
      class="filter-button filter-button-secondary"
      onclick="closeCreateBountyModal()"
    >
      Cancel
    </button>
    <button
      type="submit"
      id="submit-button"
      class="filter-button filter-button-primary"
    >
      Create Bounty
    </button>
  </div>
</form>

<script>
(function() {
  // Get form elements
  const form = document.getElementById('create-bounty-form');
  const rewardInput = document.getElementById('reward_per_post');
  const quantityInput = document.getElementById('number_of_bounties');
  const durationSelect = document.getElementById('duration');
  const bountyEndDateInput = document.getElementById('bounty-end-date');
  const timestampInput = document.getElementById('timeout_timestamp');
  const toggleButton = document.getElementById('toggle-calendar');
  const durationDiv = document.getElementById('duration-input');
  const calendarDiv = document.getElementById('calendar-input');
  const durationError = document.getElementById('duration-error');
  const calculatedDuration = document.getElementById('calculated-duration');
  const hardenButton = document.getElementById('harden-button');
  const requirementsTextarea = document.getElementById('requirements');

  // Platform fee (fetch from config)
  let platformFeePercent = 100;
  fetch('/api/v1/config')
    .then(res => res.json())
    .then(config => {
      platformFeePercent = config.platform_fee_percent || 100;
      updateCostBreakdown();
    })
    .catch(err => {
      console.error('Failed to fetch config:', err);
      updateCostBreakdown();
    });

  // Initialize calendar with default 30 days from now
  const defaultDate = new Date();
  defaultDate.setDate(defaultDate.getDate() + 30);
  bountyEndDateInput.value = defaultDate.toISOString().slice(0, 16);
  bountyEndDateInput.min = getMinEndDate();

  function getMinEndDate() {
    const minDate = new Date();
    minDate.setHours(minDate.getHours() + 24);
    return minDate.toISOString().slice(0, 16);
  }

  // Update cost breakdown
  function updateCostBreakdown() {
    const reward = parseFloat(rewardInput.value) || 0;
    const count = parseInt(quantityInput.value) || 0;
    const subtotal = reward * count;
    const fee = subtotal * (platformFeePercent / 100);
    const total = subtotal + fee;

    document.getElementById('cost-subtotal').textContent = '$' + subtotal.toFixed(2);
    document.getElementById('cost-fee').textContent = '$' + fee.toFixed(2);
    document.getElementById('cost-total').textContent = '$' + total.toFixed(2);
  }

  // Listen for input changes
  rewardInput.addEventListener('input', updateCostBreakdown);
  quantityInput.addEventListener('input', updateCostBreakdown);

  // Toggle between calendar and duration
  let useCalendar = false;
  toggleButton.addEventListener('click', function() {
    useCalendar = !useCalendar;
    if (useCalendar) {
      durationDiv.style.display = 'none';
      calendarDiv.style.display = 'block';
      toggleButton.textContent = '‚è±Ô∏è Use Duration';
      calculateDuration();
    } else {
      durationDiv.style.display = 'block';
      calendarDiv.style.display = 'none';
      toggleButton.textContent = 'üìÖ Use Calendar';
      durationError.style.display = 'none';
      calculatedDuration.textContent = '';
    }
  });

  // Calculate duration from end date
  function calculateDuration() {
    if (!bountyEndDateInput.value) {
      durationError.style.display = 'none';
      calculatedDuration.textContent = '';
      return;
    }

    const now = new Date();
    const endDate = new Date(bountyEndDateInput.value);
    const diffMs = endDate - now;
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMinutes / 60);
    const diffDays = Math.floor(diffHours / 24);

    // Validate: must be at least 24 hours in the future
    if (diffHours < 24) {
      durationError.textContent = 'End date must be at least 24 hours from now';
      durationError.style.display = 'block';
      calculatedDuration.textContent = '';
      return;
    }

    // Clear error
    durationError.style.display = 'none';

    // Calculate duration with minutes precision
    const remainingHours = diffHours % 24;
    const remainingMinutes = diffMinutes % 60;

    let durationText = '';
    if (diffDays >= 1) {
      durationText = `${diffDays} day${diffDays !== 1 ? 's' : ''}`;
      if (remainingHours > 0 || remainingMinutes > 0) {
        const parts = [];
        if (remainingHours > 0) {
          parts.push(`${remainingHours} hour${remainingHours !== 1 ? 's' : ''}`);
        }
        if (remainingMinutes > 0) {
          parts.push(`${remainingMinutes} minute${remainingMinutes !== 1 ? 's' : ''}`);
        }
        durationText += `, ${parts.join(', ')}`;
      }
    } else {
      const parts = [];
      if (diffHours > 0) {
        parts.push(`${diffHours} hour${diffHours !== 1 ? 's' : ''}`);
      }
      if (remainingMinutes > 0) {
        parts.push(`${remainingMinutes} minute${remainingMinutes !== 1 ? 's' : ''}`);
      }
      durationText = parts.join(', ');
    }

    calculatedDuration.textContent = 'Duration: ' + durationText;
  }

  bountyEndDateInput.addEventListener('change', calculateDuration);

  // AI Harden Requirements
  let hardeningInProgress = false;
  hardenButton.addEventListener('click', async function() {
    if (!requirementsTextarea.value || hardeningInProgress) return;

    hardeningInProgress = true;
    hardenButton.disabled = true;
    hardenButton.style.opacity = '0.7';
    hardenButton.style.cursor = 'wait';

    const originalText = hardenButton.querySelector('#harden-button-text');
    originalText.innerHTML = '<svg style="animation: spin 1s linear infinite; width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" stroke-linecap="round"/></svg>Processing...';

    try {
      const response = await fetch('/api/v1/bounties/harden', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ requirements: requirementsTextarea.value })
      });

      if (!response.ok) throw new Error('Failed to harden requirements');

      const data = await response.json();
      requirementsTextarea.value = data.hardened_requirements || data.requirements;
    } catch (err) {
      console.error('Failed to harden requirements:', err);
      alert('Failed to enhance requirements. Please try again.');
    } finally {
      hardeningInProgress = false;
      hardenButton.disabled = false;
      hardenButton.style.opacity = '';
      hardenButton.style.cursor = '';
      originalText.textContent = '‚ú® Harden with AI';
    }
  });

  // Handle form submission
  form.addEventListener('submit', function(e) {
    // Calculate timestamp before submission
    let timestamp = '';

    if (useCalendar) {
      if (!bountyEndDateInput.value) {
        e.preventDefault();
        alert('Please select an end date');
        return;
      }

      // Check for duration error
      if (durationError.style.display !== 'none') {
        e.preventDefault();
        alert('Please select a valid end date (at least 24 hours from now)');
        return;
      }

      timestamp = new Date(bountyEndDateInput.value).toISOString();
    } else {
      const durationDays = parseInt(durationSelect.value);
      if (!isNaN(durationDays)) {
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + durationDays);
        timestamp = endDate.toISOString();
      }
    }

    console.log('Submitting bounty with timestamp:', timestamp);
    timestampInput.value = timestamp;

    // Disable submit button
    const submitButton = document.getElementById('submit-button');
    submitButton.disabled = true;
    submitButton.innerHTML = '<svg style="animation: spin 1s linear infinite; width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" stroke-linecap="round"/></svg>Creating...';
  });

  // Handle successful bounty creation
  document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'create-bounty-form-container') {
      // Check if QR code was swapped in (successful creation)
      const hasTimer = evt.detail.target.querySelector('#countdown-timer') !== null;
      if (hasTimer) {
        // Refresh the bounty list
        const refreshEl = document.getElementById('bounty-list-container');
        if (refreshEl) htmx.trigger(refreshEl, 'refresh');

        // Update modal title
        const modalTitle = document.querySelector('.modal-title');
        if (modalTitle) modalTitle.textContent = 'Fund Bounty';
      }
    }
  });
})();
</script>
{{end}}
