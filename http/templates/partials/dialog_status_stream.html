{{define "dialog-status-stream"}}
<div class="modal-body"
     style="padding: 2rem;"
     x-data="{
         eventSource: null,
         status: 'Processing your claim...',
         currentStep: 'initializing',
         isComplete: false,
         isApproved: false,
         amount: '',
         errorMessage: '',

         init() {
             // Open SSE connection to workflow status endpoint
             this.eventSource = new EventSource('/events/assessment/{{.WorkflowID}}');

             this.eventSource.onmessage = (event) => {
                 console.log('SSE message:', event.data);
                 try {
                     const data = JSON.parse(event.data);
                     this.status = data.message || 'Processing...';
                     this.currentStep = data.current_step || '';
                     this.isComplete = data.is_complete || false;
                     this.isApproved = data.is_approved || false;
                     this.amount = data.amount || '';
                     this.errorMessage = data.error_message || '';

                     // Close connection when complete
                     if (this.isComplete) {
                         this.eventSource.close();
                         // Save wallet address on successful approval
                         if (this.isApproved) {
                             const walletInput = document.querySelector('input[name=payout_wallet]');
                             if (walletInput && walletInput.value) {
                                 localStorage.setItem('solana_wallet_address', walletInput.value);
                             }
                         }
                     }
                 } catch (err) {
                     console.error('Failed to parse SSE data:', err);
                 }
             };

             this.eventSource.onerror = (err) => {
                 console.error('SSE error:', err);
                 this.status = 'Connection error. Please refresh the page.';
                 this.eventSource.close();
             };
         },

         destroy() {
             if (this.eventSource) {
                 this.eventSource.close();
             }
         }
     }"
     x-init="init()"
     @destroy.window="destroy()">

    <!-- Status Display -->
    <div x-show="!isComplete">
        <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background-color: rgba(159, 201, 253, 0.1); border-radius: 0.5rem; border-left: 4px solid var(--accent-blue);">
            <!-- Animated spinner -->
            <div style="flex-shrink: 0; width: 2rem; height: 2rem;">
                <svg style="animation: spin 1s linear infinite; width: 100%; height: 100%;" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" stroke="var(--accent-blue)" stroke-width="3" fill="none" stroke-dasharray="60" stroke-dashoffset="15" stroke-linecap="round"/>
                </svg>
            </div>
            <div style="flex: 1;">
                <h3 style="margin: 0 0 0.5rem 0; color: var(--accent-blue); font-size: 1.25rem;">
                    Processing Claim
                </h3>
                <p style="margin: 0; color: var(--text-secondary); line-height: 1.5;" x-text="status"></p>
            </div>
        </div>
    </div>

    <!-- Success Result -->
    <div x-show="isComplete && isApproved">
        <div class="message-success" style="display: flex; align-items: flex-start; gap: 1rem;">
            <span class="material-icons-outlined" style="font-size: 2rem; flex-shrink: 0;">
                check_circle
            </span>
            <div style="flex: 1;">
                <h3 style="margin: 0 0 0.5rem 0; color: var(--success); font-size: 1.25rem;">
                    Claim Approved!
                </h3>
                <p style="margin: 0; color: var(--success); line-height: 1.5;">
                    <span x-show="amount">Payment of <strong x-text="amount"></strong> USDC has been sent to your wallet.</span>
                    <span x-show="!amount" x-text="status"></span>
                </p>
            </div>
        </div>
    </div>

    <!-- Error Result -->
    <div x-show="isComplete && !isApproved">
        <div class="message-error" style="display: flex; align-items: flex-start; gap: 1rem;">
            <span class="material-icons-outlined" style="font-size: 2rem; flex-shrink: 0;">
                error_outline
            </span>
            <div style="flex: 1;">
                <h3 style="margin: 0 0 0.5rem 0; color: var(--error); font-size: 1.25rem;">
                    Claim Rejected
                </h3>
                <p style="margin: 0; color: var(--error); line-height: 1.5;">
                    <span x-show="errorMessage" x-text="errorMessage"></span>
                    <span x-show="!errorMessage" x-text="status"></span>
                </p>
            </div>
        </div>
    </div>

    <!-- Close Button (only show when complete) -->
    <div x-show="isComplete" style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
        <button
            class="btn btn-primary"
            @click="claimModalOpen = false; destroy()"
            style="min-width: 100px;">
            Close
        </button>
    </div>
</div>

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{{end}}
