{{define "funding-qr"}}
<div style="padding: 1rem 0">
  <!-- Success Message - Above QR Code -->
  <div style="
    margin-bottom: 1.5rem;
    padding: 0.75rem;
    background-color: rgba(76, 175, 80, 0.1);
    border: 1px solid rgba(76, 175, 80, 0.3);
    border-radius: 8px;
    text-align: center;
  ">
    <p style="
      font-size: 0.875rem;
      color: rgb(129, 199, 132);
      margin: 0;
    ">
      âœ“ Complete payment to activate this bounty.
    </p>
  </div>

  <!-- QR Code with Favicon Overlay -->
  <div style="display: flex; justify-content: center; margin-bottom: 1.5rem">
    <div style="
      background-color: white;
      padding: 1rem;
      border-radius: 12px;
      display: inline-block;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      position: relative;
    ">
      <img
        src="data:image/png;base64,{{.PaymentInvoice.QRCodeData}}"
        alt="Payment QR Code"
        style="width: 256px; height: 256px; display: block"
      />
      <!-- Favicon Overlay -->
      <div style="
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 0.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      ">
        <img
          src="/static/images/favicon.png"
          alt="IncentivizeThis"
          style="width: 48px; height: 48px; display: block"
        />
      </div>
    </div>
  </div>

  <!-- Countdown Timer -->
  <div style="text-align: center; margin-bottom: 1rem">
    <div style="
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    ">
      Payment expires in:
    </div>
    <div style="
      font-size: 1.5rem;
      font-weight: 600;
      color: rgb(255, 183, 77);
      font-family: monospace;
    " id="countdown-timer">
      Calculating...
    </div>
  </div>

  <!-- Buttons Container -->
  <div style="display: flex; gap: 0.75rem;">
    <!-- View Bounty Button -->
    <a
      href="/browse/{{.BountyID}}"
      style="
        flex: 1;
        padding: 0.75rem 1rem;
        background-color: rgb(200, 200, 200);
        color: rgb(50, 50, 50);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        transition: background-color 0.2s ease;
        font-size: 0.875rem;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
      "
      onmouseover="this.style.backgroundColor='rgb(180, 180, 180)'"
      onmouseout="this.style.backgroundColor='rgb(200, 200, 200)'"
    >
      View Bounty
    </a>

    <!-- Open in Wallet Button -->
    <a
      href="{{.PaymentInvoice.PaymentURL}}"
      onclick="console.log('Solana Pay URL:', '{{.PaymentInvoice.PaymentURL}}'); return true;"
      style="
        flex: 1;
        padding: 0.75rem 1rem;
        background-color: rgb(160, 202, 252);
        color: rgb(0, 50, 88);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        transition: background-color 0.2s ease;
        font-size: 0.875rem;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
      "
      onmouseover="this.style.backgroundColor='rgb(140, 182, 232)'"
      onmouseout="this.style.backgroundColor='rgb(160, 202, 252)'"
    >
      Open in Wallet
    </a>
  </div>
</div>

<script>
// Countdown timer - prevent multiple timers from running
(function() {
  console.log('[Timer] Script started');

  // Clear any globally running payment timer
  if (window.paymentTimerInterval) {
    console.log('[Timer] Clearing previous global timer:', window.paymentTimerInterval);
    clearInterval(window.paymentTimerInterval);
    window.paymentTimerInterval = null;
  }

  // Use requestAnimationFrame to ensure DOM is fully ready
  requestAnimationFrame(function() {
    console.log('[Timer] requestAnimationFrame callback started');

    const timerEl = document.getElementById('countdown-timer');
    if (!timerEl) {
      console.error('[Timer] Countdown timer element not found in DOM');
      return;
    }
    console.log('[Timer] Timer element found:', timerEl);

    // Clear any existing timer on this element
    const existingTimerId = timerEl.dataset.timerId;
    if (existingTimerId) {
      console.log('[Timer] Clearing existing timer on element:', existingTimerId);
      clearInterval(parseInt(existingTimerId));
    }

    const expiresAtStr = '{{.PaymentInvoice.ExpiresAt.Format "2006-01-02T15:04:05Z07:00"}}';
    console.log('[Timer] Raw expiration string:', expiresAtStr);

    const expiresAt = new Date(expiresAtStr);
    console.log('[Timer] Parsed expiration date:', expiresAt);

    // Check if date is valid
    if (isNaN(expiresAt.getTime())) {
      console.error('[Timer] Invalid expiration date:', expiresAtStr);
      timerEl.textContent = 'Error loading timer';
      timerEl.style.color = 'rgb(244, 67, 54)';
      return;
    }

    const now = new Date();
    const diff = expiresAt - now;
    console.log('[Timer] Time diff (ms):', diff, '(minutes:', Math.floor(diff / 60000), ')');

    function updateCountdown() {
      const currentTimerEl = document.getElementById('countdown-timer');
      if (!currentTimerEl) {
        // Element was removed from DOM, stop the timer
        console.log('[Timer] Element removed from DOM, stopping timer');
        if (window.paymentTimerInterval) {
          clearInterval(window.paymentTimerInterval);
          window.paymentTimerInterval = null;
        }
        if (timerEl.dataset.timerId) {
          clearInterval(parseInt(timerEl.dataset.timerId));
          delete timerEl.dataset.timerId;
        }
        return;
      }

      const now = new Date();
      const diff = expiresAt - now;

      if (diff <= 0) {
        console.log('[Timer] Payment expired');
        currentTimerEl.textContent = 'Expired';
        currentTimerEl.style.color = 'rgb(244, 67, 54)';
        if (window.paymentTimerInterval) {
          clearInterval(window.paymentTimerInterval);
          window.paymentTimerInterval = null;
        }
        if (timerEl.dataset.timerId) {
          clearInterval(parseInt(timerEl.dataset.timerId));
          delete timerEl.dataset.timerId;
        }
        return;
      }

      const minutes = Math.floor(diff / 60000);
      const seconds = Math.floor((diff % 60000) / 1000);
      const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      currentTimerEl.textContent = timeStr;
      console.log('[Timer] Updated countdown to:', timeStr);
    }

    // Initial update
    console.log('[Timer] Calling initial updateCountdown');
    updateCountdown();

    // Start interval and store ID globally and on the element
    const intervalId = setInterval(updateCountdown, 1000);
    window.paymentTimerInterval = intervalId;
    timerEl.dataset.timerId = intervalId.toString();
    console.log('[Timer] Interval started with ID:', intervalId);
  });
})();
</script>
{{end}}

