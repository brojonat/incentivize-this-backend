{{define "funding-qr"}}
<div style="padding: 1rem 0">
  <!-- Payment Required Message - Above QR Code -->
  <div style="
    margin-bottom: 1.5rem;
    padding: 0.75rem;
    background-color: rgba(255, 152, 0, 0.1);
    border: 1px solid rgba(255, 152, 0, 0.3);
    border-radius: 8px;
    text-align: center;
  ">
    <p style="
      font-size: 0.875rem;
      color: rgb(255, 167, 38);
      margin: 0;
    ">
      âš  Complete payment to activate this bounty.
    </p>
  </div>

  <!-- QR Code with Favicon Overlay -->
  <div style="display: flex; justify-content: center; margin-bottom: 1.5rem">
    <div style="
      background-color: white;
      padding: 1rem;
      border-radius: 12px;
      display: inline-block;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      position: relative;
    ">
      <img
        src="data:image/png;base64,{{.PaymentInvoice.QRCodeData}}"
        alt="Payment QR Code"
        style="width: 256px; height: 256px; display: block"
      />
      <!-- Favicon Overlay -->
      <div style="
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 0.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      ">
        <img
          src="/static/images/favicon.png"
          alt="IncentivizeThis"
          style="width: 48px; height: 48px; display: block"
        />
      </div>
    </div>
  </div>

  <!-- Countdown Timer -->
  <div style="text-align: center; margin-bottom: 1rem">
    <div style="
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    ">
      Bounty expires in:
    </div>
    <div style="
      font-size: 1.5rem;
      font-weight: 600;
      color: rgb(255, 183, 77);
      font-family: monospace;
    " id="countdown-timer">
      Calculating...
    </div>
  </div>

  <!-- Buttons Container -->
  <div style="display: flex; gap: 0.75rem;">
    <!-- View Bounty Button -->
    <a
      href="/browse/{{.BountyID}}"
      style="
        flex: 1;
        padding: 0.75rem 1rem;
        background-color: rgb(200, 200, 200);
        color: rgb(50, 50, 50);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        transition: background-color 0.2s ease;
        font-size: 0.875rem;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
      "
      onmouseover="this.style.backgroundColor='rgb(180, 180, 180)'"
      onmouseout="this.style.backgroundColor='rgb(200, 200, 200)'"
    >
      View Bounty
    </a>

    <!-- Open in Wallet Button -->
    <button
      id="open-wallet-btn"
      onclick="openWallet('{{.PaymentInvoice.PaymentURL}}')"
      style="
        flex: 1;
        padding: 0.75rem 1rem;
        background-color: rgb(160, 202, 252);
        color: rgb(0, 50, 88);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        transition: background-color 0.2s ease;
        font-size: 0.875rem;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
      "
      onmouseover="this.style.backgroundColor='rgb(140, 182, 232)'"
      onmouseout="this.style.backgroundColor='rgb(160, 202, 252)'"
    >
      Open in Wallet
    </button>
  </div>

  <!-- Store expiration data in a data attribute for JS to read after swap -->
  <div id="countdown-timer-data"
       data-expires-at="{{.PaymentInvoice.ExpiresAt.UnixMilli}}"
       style="display: none;"></div>

  <script>
  // Open wallet function - tries to open the Solana Pay URL
  function openWallet(url) {
    console.log('[Wallet] Attempting to open:', url);
    // Try to open in new window/tab (will trigger wallet app on mobile)
    window.location.href = url;
  }

  // Initialize countdown timer function that will be called by HTMX event
  function initPaymentTimer() {
    console.log('[Timer] initPaymentTimer called');

    // Increment generation counter - this makes all old timers obsolete
    window.paymentTimerGeneration = (window.paymentTimerGeneration || 0) + 1;
    const myGeneration = window.paymentTimerGeneration;
    console.log('[Timer] Starting timer generation:', myGeneration);

    // Clear the specific interval if it exists
    if (window.paymentTimerInterval) {
      console.log('[Timer] Clearing previous interval:', window.paymentTimerInterval);
      clearInterval(window.paymentTimerInterval);
      window.paymentTimerInterval = null;
    }

    const timerEl = document.getElementById('countdown-timer');
    if (!timerEl) {
      console.error('[Timer] Countdown timer element not found in DOM');
      return;
    }
    console.log('[Timer] Timer element found:', timerEl);

    // Get expiration timestamp from data attribute
    const dataEl = document.getElementById('countdown-timer-data');
    if (!dataEl) {
      console.error('[Timer] Timer data element not found');
      return;
    }

    const expiresAtMs = parseInt(dataEl.dataset.expiresAt);
    console.log('[Timer] Expiration timestamp (ms):', expiresAtMs);

    const expiresAt = new Date(expiresAtMs);
    console.log('[Timer] Parsed expiration date:', expiresAt);
    console.log('[Timer] Is valid date?:', !isNaN(expiresAt.getTime()));

    // Check if date is valid
    if (isNaN(expiresAt.getTime()) || expiresAtMs === 0) {
      console.error('[Timer] Invalid expiration timestamp:', expiresAtMs);
      timerEl.textContent = 'Error loading timer';
      timerEl.style.color = 'rgb(244, 67, 54)';
      return;
    }

    const now = new Date();
    const diff = expiresAt - now;
    console.log('[Timer] Time diff (ms):', diff, '(minutes:', Math.floor(diff / 60000), ')');

    let intervalId;

    function updateCountdown() {
      // Check if this timer is obsolete (newer timer started)
      if (myGeneration !== window.paymentTimerGeneration) {
        console.log('[Timer] Generation', myGeneration, 'obsolete (current:', window.paymentTimerGeneration + '), stopping');
        clearInterval(intervalId);
        return;
      }

      const currentTimerEl = document.getElementById('countdown-timer');
      if (!currentTimerEl) {
        // Element was removed from DOM, stop the timer
        console.log('[Timer] Element removed from DOM, stopping timer generation', myGeneration);
        clearInterval(intervalId);
        if (window.paymentTimerInterval === intervalId) {
          window.paymentTimerInterval = null;
        }
        return;
      }

      const now = new Date();
      const diff = expiresAt - now;

      if (diff <= 0) {
        console.log('[Timer] Payment expired (generation', myGeneration + ')');
        currentTimerEl.textContent = 'Expired';
        currentTimerEl.style.color = 'rgb(244, 67, 54)';
        clearInterval(intervalId);
        if (window.paymentTimerInterval === intervalId) {
          window.paymentTimerInterval = null;
        }
        return;
      }

      const minutes = Math.floor(diff / 60000);
      const seconds = Math.floor((diff % 60000) / 1000);
      const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      currentTimerEl.textContent = timeStr;
      console.log('[Timer] Updated countdown to:', timeStr, '(gen', myGeneration + ')');
    }

    // Initial update
    console.log('[Timer] Calling initial updateCountdown');
    updateCountdown();

    // Start interval and store ID globally
    intervalId = setInterval(updateCountdown, 1000);
    window.paymentTimerInterval = intervalId;
    console.log('[Timer] Interval started with ID:', intervalId, '(generation', myGeneration + ')');
  }

  // Note: initPaymentTimer() is called by the HTMX afterSwap event listener
  // in the parent page, not here. Calling it twice causes duplicate timers.
  </script>
</div>
{{end}}

